# ADR: Remote 工具架构重构

## 状态
已采纳

## 背景
当前 `remote` 工具存在以下问题：
1. **模块耦合度高**：CLI、业务逻辑、基础设施代码混在一起
2. **可扩展性差**：难以添加新功能（如新的代理类型、存储后端）
3. **日志系统简陋**：使用简单的 print，无法区分 stdout/stderr，缺乏结构化日志
4. **用户体验不佳**：错误提示不够友好，配置参数有限
5. **测试困难**：业务逻辑与 CLI/IO 耦合，难以单元测试

## 决策
采用**三层架构**重构整个框架：

### 1. Core 层（核心基础设施）
- **位置**：`remote/core/`
- **职责**：
  - SSH 连接管理（`RemoteClient`）
  - 配置解析与验证
  - 日志系统（Rich logging）
  - 可观测性（Telemetry）
  - 通用工具函数
  - 接口定义（抽象）

### 2. Domain 层（业务逻辑）
- **位置**：`remote/domain/`
- **职责**：
  - Proxy 服务（启动、停止、监控、重启）
  - Sync 服务（文件、脚本、配置块）
  - 业务规则与验证
  - 领域模型（Config、State 等）

**原则**：Domain 层不依赖 CLI、Typer、文件系统等具体实现，通过依赖注入接收接口。

### 3. Adapters 层（适配器）
- **位置**：`remote/adapters/`
- **职责**：
  - CLI 适配器（Typer 命令注册、参数解析、输出渲染）
  - 配置加载器（TOML、环境变量、CLI 参数合并）
  - 状态存储适配器（文件系统、未来可扩展数据库）

### 4. Infrastructure 层（基础设施实现）
- **位置**：`remote/infrastructure/`
- **职责**：
  - 状态存储实现（文件系统）
  - 日志处理器实现
  - 其他基础设施实现

## 架构图

```
┌─────────────────────────────────────────┐
│         Adapters (CLI Layer)           │
│  - CLI Commands (Typer)                │
│  - Config Loader                        │
│  - Output Renderer (Rich Console)      │
└──────────────┬──────────────────────────┘
               │ 调用服务接口
┌──────────────▼──────────────────────────┐
│         Domain (Business Logic)         │
│  - ProxyService                         │
│  - SyncService                          │
│  - Domain Models                        │
└──────────────┬──────────────────────────┘
               │ 依赖注入接口
┌──────────────▼──────────────────────────┐
│         Core (Infrastructure)           │
│  - RemoteClient                         │
│  - Logging (Rich)                       │
│  - Config Parser                        │
│  - Interfaces                           │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│      Infrastructure (Implementations)   │
│  - FileStateStore                       │
│  - RichLogHandler                       │
└─────────────────────────────────────────┘
```

## 关键设计决策

### 1. 日志系统
- **使用 Rich**：提供结构化、彩色、格式化的日志输出
- **区分通道**：日志输出到 stderr，业务输出到 stdout
- **结构化元数据**：支持上下文信息（instance_name、operation 等）
- **日志级别**：DEBUG、INFO、WARNING、ERROR、CRITICAL

### 2. 状态管理
- **接口抽象**：定义 `StateStore` 接口
- **文件实现**：首个实现使用文件系统（PID、JSON、日志文件）
- **未来扩展**：可替换为数据库、Redis 等

### 3. 配置系统
- **优先级**：环境变量 > CLI 参数 > TOML 配置 > 默认值
- **合并策略**：支持多配置文件合并
- **验证**：配置解析时进行完整验证

### 4. CLI 体验
- **Rich Console**：所有用户提示使用 Rich 渲染
- **友好错误**：提供上下文、建议、示例
- **交互式确认**：危险操作需要确认
- **进度显示**：长时间操作显示进度条

### 5. 非兼容性决策
- **不维护旧版本**：直接重构，不提供兼容层
- **API 变更**：CLI 命令可能略有调整
- **配置格式**：保持 TOML 格式，但字段可能扩展

## 成功标准
1. ✅ 代码结构清晰，模块职责明确
2. ✅ 日志系统完善，输出美观且结构化
3. ✅ CLI 参数丰富，用户体验友好
4. ✅ 易于扩展新功能（新代理类型、存储后端等）
5. ✅ 代码可测试（Domain 层可独立测试）

## 依赖关系

### 当前耦合点
1. `cli.py` → `config.py` → `client.py` → `proxy/manager.py`
2. `proxy/manager.py` 直接使用 Typer、文件系统
3. `sync/__init__.py` 直接使用 Typer、文件系统
4. 日志使用简单的 print，无法区分通道

### 重构后依赖
1. `adapters/cli/*` → `domain/*` → `core/*`
2. `domain/*` 通过接口依赖 `infrastructure/*`
3. 日志统一通过 `core/logging` 模块

## 实施计划
1. **阶段1**：创建 ADR 和依赖分析
2. **阶段2**：创建目录结构，迁移 Core 层
3. **阶段3**：实现 Rich 日志系统
4. **阶段4**：实现 Domain 层（Proxy 服务）
5. **阶段5**：重写 CLI 适配层
6. **阶段6**：更新文档和示例

## 后续考虑
- 支持多代理类型（HTTP、SOCKS5、自定义）
- 支持配置热重载
- 支持插件系统
- 支持远程状态同步（多机器共享配置）

